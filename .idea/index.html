<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WOSB — Ultimate Captain's Tool</title>
  <meta name="description" content="World of Sea Battle — Guild-only map and trade planner."/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <style> html, body, #root { height: 100%; } </style>
</head>
<body class="bg-slate-950">
  <div id="root"></div>
  <script type="text/babel">
    const { useMemo, useRef, useState, useEffect } = React;
    const ROUTES = ["/", "/map", "/trade", "/loadouts", "/production", "/guides"];
    function useHashRoute() {
      const [route, setRoute] = useState(() => (location.hash.replace("#", "") || "/"));
      useEffect(() => {
        const handler = () => setRoute(location.hash.replace("#", "") || "/");
        window.addEventListener("hashchange", handler);
        return () => window.removeEventListener("hashchange", handler);
      }, []);
      function navigate(r) { if (!ROUTES.includes(r)) return; location.hash = r; }
      return [route, navigate];
    }

    const PORTS = [
      { name: "Assab", x: 97, y: 1211 }, { name: "Cursed City", x: 101, y: 636 },
      { name: "Al-Khalif", x: 110, y: 1393 }, { name: "Nisogora", x: 166, y: 434 },
      { name: "Nordberg", x: 217, y: 301 }, { name: "West Bastion", x: 214, y: 818 },
      { name: "Sharhat", x: 290, y: 1105 }, { name: "Oneg", x: 341, y: 121 },
      { name: "Naabad Stronghold", x: 403, y: 676 }, { name: "Gelbion", x: 483, y: 342 },
      { name: "Masadora", x: 499, y: 829 }, { name: "Devios", x: 540, y: 1177 },
      { name: "El Tigre", x: 552, y: 1364 }, { name: "Surako", x: 553, y: 529 },
      { name: "Corsa-Nois Bay", x: 672, y: 102 }, { name: "Bridgetown", x: 730, y: 836 },
      { name: "San Cristobel", x: 751, y: 1350 }, { name: "Charleston", x: 763, y: 986 },
      { name: "Nevis", x: 826, y: 539 }, { name: "Pirate City", x: 843, y: 1419 },
      { name: "Everston", x: 867, y: 232 }, { name: "Laguna Blanco", x: 975, y: 969 },
      { name: "Aruba", x: 1083, y: 354 }, { name: "San Martinas", x: 1089, y: 1375 },
      { name: "Tortuga", x: 1129, y: 771 }, { name: "La Navidad", x: 1244, y: 918 },
      { name: "Thermopylae", x: 1260, y: 617 }, { name: "Aldansk", x: 1274, y: 133 },
      { name: "South Bastion", x: 1297, y: 1287 }, { name: "Gray Island", x: 1343, y: 403 },
      { name: "St. John", x: 1375, y: 1016 }, { name: "Fiji", x: 1454, y: 747 },
      { name: "Severoangelsk", x: 1463, y: 140 }, { name: "Bord Radel", x: 1528, y: 1400 },
      { name: "North Bastion", x: 1553, y: 355 }, { name: "Los Catuano", x: 1582, y: 1162 },
      { name: "Brandport", x: 1641, y: 664 }, { name: "Santa Maria", x: 1716, y: 1021 },
      { name: "Northside", x: 1718, y: 201 }, { name: "Puerto Salada", x: 1739, y: 1232 },
      { name: "Freebooter Bay", x: 1763, y: 835 }, { name: "Freedom Bay", x: 1769, y: 508 },
    ];
    function dist(a,b){const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy);}

    function Nav({ route, go }){
      const entries=[{label:"Home",path:"/"},{label:"Map",path:"/map"},{label:"Trade",path:"/trade"},{label:"Loadouts",path:"/loadouts"},{label:"Production",path:"/production"},{label:"Guides",path:"/guides"}];
      return(<header className="flex items-center justify-between p-3 bg-slate-900 text-slate-100 border-b border-slate-800">
        <div className="font-bold">WOSB — Ultimate Captain's Tool</div>
        <nav className="flex gap-2 text-sm">{entries.map(e=>(
          <button key={e.path} onClick={()=>go(e.path)} className={`px-3 py-1.5 rounded-xl ${route===e.path?"bg-slate-700":"bg-slate-800 hover:bg-slate-700"}`}>{e.label}</button>
        ))}</nav></header>);
    }

    function HomePage({ go }){
      return(<div className="p-6 text-slate-100 grid grid-cols-1 xl:grid-cols-3 gap-4">
        <section className="rounded-2xl bg-slate-900/70 p-4 border border-slate-800">
          <h2 className="text-xl font-semibold">Start Here</h2>
          <p className="text-slate-300 mt-1">Plan routes, manage loadouts, design production, and read guides.</p>
          <div className="mt-3 flex gap-2">
            <button className="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500" onClick={()=>go("/map")}>Open Map</button>
            <button className="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500" onClick={()=>go("/trade")}>Open Trade</button>
          </div>
        </section>
        <section className="rounded-2xl bg-slate-900/70 p-4 border border-slate-800">
          <h3 className="font-semibold">What You Can Do</h3>
          <ul className="list-disc ml-5 text-slate-300 text-sm mt-2 space-y-1">
            <li>Use the interactive map (embedded 1:1 from your reference project).</li>
            <li>Upload <b>private CSV</b> of prices; compute best routes.</li>
            <li>Adjust distance penalty to prefer short hops or long hauls.</li>
          </ul>
        </section>
        <section className="rounded-2xl bg-slate-900/70 p-4 border border-slate-800">
          <h3 className="font-semibold">Data Inputs</h3>
          <ul className="list-disc ml-5 text-slate-300 text-sm mt-2 space-y-1">
            <li>Trade CSV format: first column <b>Port</b>, then commodity columns.</li>
            <li>Ports must match map names (Aldansk, Bord Radel, etc.).</li>
          </ul>
        </section>
      </div>);
    }

    function MapPage(){ return (<div className="w-full h-[calc(100vh-56px)] bg-black"><iframe src="./wosb-map/index.html" title="WOSB Map" className="w-full h-full border-0"></iframe></div>); }

    function TradePage(){
      const [commodityList,setCommodityList]=useState([]);
      const [priceTable,setPriceTable]=useState({});
      const [selectedCommodity,setSelectedCommodity]=useState("");
      const [distanceWeight,setDistanceWeight]=useState(0.02);
      const [topRoutes,setTopRoutes]=useState([]);
      const nameToPort=useMemo(()=>{const m={}; PORTS.forEach(p=>m[p.name]=p); return m;},[]);
      function handleCSV(file){
        Papa.parse(file, { header:true, skipEmptyLines:true, complete:(results)=>{
          const rows=results.data||[]; const cols=results.meta.fields||[]; const commodities=cols.filter(c=>c!=="Port");
          const price={};
          for(const row of rows){
            const port=String(row["Port"]||"").trim(); if(!port) continue;
            price[port]=price[port]||{};
            for(const c of commodities){
              const v=parseFloat(String(row[c]).replace(/[^0-9.\-]/g,"")); if(!isNaN(v)) price[port][c]=v;
            }
          }
          setCommodityList(commodities); setPriceTable(price); if(!selectedCommodity && commodities.length) setSelectedCommodity(commodities[0]);
        }});
      }
      function distAB(a,b){const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy);}
      function computeTopRoutes(){
        if(!selectedCommodity) return;
        const ports=Object.keys(priceTable).filter(p=>nameToPort[p]);
        const pairs=[];
        for(let i=0;i<ports.length;i++){
          for(let j=0;j<ports.length;j++){
            if(i===j) continue;
            const a=ports[i], b=ports[j];
            const buy=priceTable[a]?.[selectedCommodity];
            const sell=priceTable[b]?.[selectedCommodity];
            if(buy==null || sell==null) continue;
            const profit=sell-buy;
            const d=distAB(nameToPort[a], nameToPort[b]);
            const score=profit - distanceWeight*d;
            pairs.push({from:a,to:b,buy,sell,profit,distance:Math.round(d),score});
          }
        }
        setTopRoutes(pairs.sort((x,y)=>y.score-x.score).slice(0,10));
      }
      return (
        <div className="p-6 text-slate-100 grid grid-cols-1 xl:grid-cols-3 gap-4 bg-slate-950 min-h-[calc(100vh-56px)]">
          <section className="xl:col-span-1 rounded-2xl bg-slate-900/70 p-4 border border-slate-800 space-y-3">
            <h2 className="text-xl font-semibold">Trade Data</h2>
            <input type="file" accept=".csv,text/csv" onChange={(e)=>e.target.files && handleCSV(e.target.files[0])} className="block w-full text-sm file:mr-3 file:py-1.5 file:px-3 file:rounded-xl file:border-0 file:bg-slate-700 file:text-white"/>
            <div>
              <label className="text-sm">Commodity</label>
              <select value={selectedCommodity} onChange={(e)=>setSelectedCommodity(e.target.value)} className="w-full mt-1 rounded-xl bg-slate-800 p-2">
                <option value="" disabled>Select a commodity</option>
                {commodityList.map(c=><option key={c} value={c}>{c}</option>)}
              </select>
            </div>
            <div>
              <label className="text-sm">Distance penalty (per grid): {distanceWeight.toFixed(3)}</label>
              <input type="range" min="0" max="0.1" step="0.001" value={distanceWeight} onChange={(e)=>setDistanceWeight(parseFloat(e.target.value))} className="w-full"/>
            </div>
            <button onClick={computeTopRoutes} className="w-full py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">Compute Best Routes</button>
            {topRoutes.length>0 && (
              <div className="mt-3">
                <h3 className="font-semibold">Top Opportunities</h3>
                <div className="mt-2 space-y-2">
                  {topRoutes.map((r,i)=>(
                    <div key={i} className="rounded-2xl bg-slate-800 p-3 text-sm">
                      <div className="font-semibold">{r.from} → {r.to}</div>
                      <div className="text-slate-300">Profit: <span className="text-emerald-400">+{r.profit}</span> | Dist: {r.distance} | Score: {r.score.toFixed(1)}</div>
                      <div className="text-slate-400">Buy {selectedCommodity}: {r.buy} | Sell: {r.sell}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </section>
          <section className="xl:col-span-2 rounded-2xl bg-slate-900/70 p-4 border border-slate-800">
            <h2 className="text-xl font-semibold mb-2">Planner Map</h2>
            <p className="text-slate-300 text-sm mb-2">Upload prices on the left, then compute routes and visualize below.</p>
            <MiniMap selectedRoutes={topRoutes}/>
          </section>
        </div>
      );
    }

    function MiniMap({ selectedRoutes }){
      const [scale]=useState(0.65); const [offset]=useState({x:0,y:0});
      const bounds=useMemo(()=>{const maxX=Math.max(...PORTS.map(p=>p.x)); const maxY=Math.max(...PORTS.map(p=>p.y)); return {width:maxX+100,height:maxY+100};},[]);
      return(<svg width="100%" height="520" viewBox={`0 0 ${bounds.width} ${bounds.height}`} style={{transform:`translate(${offset.x}px, ${offset.y}px) scale(${scale})`, transformOrigin:"0 0"}} className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl">
        <defs><pattern id="grid-mini" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="#1f2937" strokeWidth="2"/></pattern></defs>
        <rect width="100%" height="100%" fill="url(#grid-mini)"/>
        {PORTS.map(p=>(<g key={p.name}><circle cx={p.x} cy={p.y} r="5" fill="#e5e7eb" opacity="0.95"/><text x={p.x+8} y={p.y-8} fontSize="14" fill="#e5e7eb">{p.name}</text></g>))}
        {selectedRoutes.map((r,i)=>{const A=PORTS.find(p=>p.name===r.from); const B=PORTS.find(p=>p.name===r.to); return <line key={i} x1={A.x} y1={A.y} x2={B.x} y2={B.y} stroke="#34d399" strokeWidth="4" opacity="0.6"/>;})}
      </svg>);
    }

    function LoadoutsPage(){ return (<div className="p-6 text-slate-100">Loadouts coming soon.</div>); }
    function ProductionPage(){ return (<div className="p-6 text-slate-100">Production planner coming soon.</div>); }
    function GuidesPage(){ return (<div className="p-6 text-slate-100">Guides coming soon.</div>); }

    function App(){ const [route,go]=useHashRoute(); return(<div className="w-full h-screen bg-slate-950">
      <Nav route={route} go={go}/>
      {route==="/" && <HomePage go={go}/>}
      {route==="/map" && <MapPage/>}
      {route==="/trade" && <TradePage/>}
      {route==="/loadouts" && <LoadoutsPage/>}
      {route==="/production" && <ProductionPage/>}
      {route==="/guides" && <GuidesPage/>}
    </div>); }
    const root = ReactDOM.createRoot(document.getElementById("root")); root.render(<App/>);
  </script>
</body>
</html>
